import Http'Request { Request }
import Http'Response { Response }
import Http'Server
import Os'Environment
import Os'File
import Os'Process

import 'database
import 'database'metric
import 'database'record
import 'logger
import 'server

main = \(ctx context) none {
  if e = run(ctx) as none {
    none
  } else {
    debug(e)
    Process'Exit(ctx.Os, 1)
  }
}

run = \(ctx context) none | error {
  a = Application{
    MetricRepository: metric'New(),
    RecordRepository: record'New(),
  }

  server'Serve(
    server'New(
      ctx.Http,
      database'New(ctx.Sql, Environment'Variable(ctx.Os, "DATABASE_URI")?)?,
      logger'New(ctx.Os),
    ),
    Environment'Variable(ctx.Os, "SERVER_ADDRESS")?,
  )
}
